"use strict";function DeviceLabConfig(){this.url="http://192.168.1.40:3000"}function DeviceController(){function a(a,c){console.log(this);var d=window.device.platform,e=-1;if("android"===d.toLowerCase()?e=0:"iphone"===d.toLowerCase()&&(e=1),-1===e)return void c("Tried to register a device which isn't Android or iOS");var f={name:window.device.model,nickname:b(),platformId:e,platformVersion:window.device.version,uuid:window.device.uuid};a(f)}function b(){if(!c())return window.device.model;var a=localStorage.getItem("device-nickname");return("undefined"==typeof a||null===a)&&(a=window.device.model),a}function c(){return Modernizr&&Modernizr.localstorage}this.saveDevice=function(a){console.log("hasLocalStorage() = ",c()),c()&&(console.log("device = "+a.device_id),localStorage.setItem("device_id",a.device_id),console.log("localStorage.getItem('device_id') = ",localStorage.getItem("device_id")))},this.getDevice=function(b,c){"undefined"!=typeof window.device?(console.log("Number 1"),a(function(a){var c=this.getDeviceId();"undefined"!=typeof c&&null!==c&&(a.deviceId=c),b(a)}.bind(this),c)):document.addEventListener("deviceready",function(){console.log("Number 2"),a(function(a){var c=this.getDeviceId();"undefined"!=typeof c&&null!==c&&(a.deviceId=c),b(a)}.bind(this),c).bind(this)},!1)},this.getDeviceId=function(){return console.log("hasLocalStorage() = ",c()),c()?(console.log("localStorage.getItem('device_id') = ",localStorage.getItem("device_id")),localStorage.getItem("device_id")):void 0}}function RegistrationController(){function a(a,d,e,f){c.getDevice(function(c){b(a,d,c,e,f)},function(a){f(a)})}function b(a,b,c,e,f){var g=new XMLHttpRequest;g.open("POST",d.url+"/devices/add/",!0),g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onreadystatechange=function(a){if(4===a.target.readyState)if(a.target.responseText.length>0){var b=JSON.parse(a.target.responseText);200!==a.target.status?"already_added"===b.error.code?e(c):f(b.error.msg):(console.log("response = ",b),c.device_id=b.data.device_id,e(c))}else f("Sorry, we couldn't add your device to the lab, there appears to be a problem with the server.")}.bind(this),g.timeout=1e4,g.ontimeout=function(){f("Sorry, we couldn't add your device to the lab, there appears to be a problem with the server.")};var h="id_token="+encodeURIComponent(a)+"&cloud_msg_id="+b+"&device_name="+encodeURIComponent(c.name)+"&device_nickname="+encodeURIComponent(c.nickname)+"&platform_id="+encodeURIComponent(c.platformId)+"&platform_version="+encodeURIComponent(c.platformVersion);"undefined"!=typeof c.deviceId&&null!==c.deviceId&&(h+="&device_id="+encodeURIComponent(c.deviceId)),g.send(h)}var c=new DeviceController,d=new DeviceLabConfig;this.registerDeviceWithLab=function(b,c,d){return"undefined"==typeof gcmlaunchbrowser?void d("The GCM Launch Browser plugin hasn't been installed"):void gcmlaunchbrowser.getRegistrationId(function(e){a(b,e.regId,c,d)},function(a){"undefined"!=typeof a&&a||(a="An unknown error occurred while setting up push notifications."),d(a)})},this.deregisterDevice=function(a,b,c){console.log(a,b);var e=new XMLHttpRequest;e.open("POST",d.url+"/device/delete/",!0),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(a){if(4===a.target.readyState)if(a.target.responseText.length>0){var b=JSON.parse(a.target.responseText);200!==a.target.status?c(b.error.msg):c()}else c("Sorry, we couldn't add your device to the lab, there appears to be a problem with the server.")}.bind(this),e.timeout=1e4,e.ontimeout=function(){c("Sorry, we couldn't add your device to the lab, there appears to be a problem with the server.")};var f="id_token="+encodeURIComponent(a)+"&device_id="+b;e.send(f)}}function SignInController(){this.loginInToGPlus=function(a,b){return"undefined"==typeof cordova?void b("Cordova isn't available to the page"):"undefined"==typeof nativegplussignin?void b("The NativeGPlusSignIn plugin isn't loaded into the page"):void nativegplussignin.login(function(b){a(b)},function(a){b(a)})}}function AppController(){function a(a){if(d!==a){var b=document.querySelector(".sign-in"),c=document.querySelector(".loading"),h=document.querySelector(".home");switch(a){case f:c.classList.add("hide"),h.classList.add("hide"),b.classList.remove("hide");break;case e:c.classList.remove("hide"),b.classList.add("hide"),h.classList.add("hide");break;case g:c.classList.add("hide"),b.classList.add("hide"),h.classList.remove("hide")}d=a}}function b(b){i.registerDeviceWithLab(b,function(b){b.device_id&&j.saveDevice(b),a(g)},function(b){a(f),window.alert("Error registering your device for push notifications:\n"+b)})}var c,d,e=0,f=1,g=2,h=new SignInController,i=new RegistrationController,j=new DeviceController;this.login=function(){a(e),h.loginInToGPlus(function(a){c=a.id_token,b(c)},function(b){a(f),window.alert("An Error Occured While Loading the Page:\n"+b)})},this.deregisterDevice=function(){a(e),i.deregisterDevice(c,j.getDeviceId(),function(b){return b?(window.alert(b),void a(g)):void a(f)})},this.init=function(){var b=document.querySelector(".sign-in > .wrapper > button");b.addEventListener("click",function(a){a.preventDefault(),this.login()}.bind(this),!1);var c=document.querySelector(".home > .wrapper > button");c.addEventListener("click",function(a){a.preventDefault(),this.deregisterDevice()}.bind(this),!1),a(f)}}"undefined"!=typeof cordova?document.addEventListener("deviceready",function(){var a=new AppController;a.init()},!1):console.log("Cordova is not loaded");